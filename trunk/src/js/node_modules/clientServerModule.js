var utils = require('twainetUtils');
var module = require('ipcModule');
var conn = require('clientServerConnector');
var net = require('net');

exports.ClientServerModule = function(name) {
	module.IPCModule.call(this, name);
}

exports.client = "ClientName";
exports.server = "ServerName";

utils.extend(exports.ClientServerModule, module.IPCModule);

exports.ClientServerModule.prototype.StartServer = function(port) {
	var self = this;
	var server = net.createServer(function(c) {
		self.addConnector(conn.ClientServerConnector, c, exports.client, self.name);
	});

	server.listen(port, function() { //'listening' listener
		console.log('server bound');
	});
}

exports.ClientServerModule.prototype.Connect = function(host, port) {
	var self = this;
	var client = net.connect({host: host, port: port}, function() { //'connect' listener
		console.log('client connected');
		self.addConnector(conn.ClientServerConnector, client, exports.server, self.name);
	});
}

exports.ClientServerModule.prototype.InitTunnelServer = function(object, pbBuilder) {
	var extSessionId = object.get("ext_session_id"),
		ownSessionId = object.get("own_session_id"),
		initTunnelStarted = pbBuilder.build("client_server.InitTunnelStarted"),
		tunnelType = pbBuilder.build("client_server.TunnelType"),
		myMessageOne = new initTunnelStarted(ownSessionId, extSessionId),
		myMessageTwo = new initTunnelStarted(extSessionId, ownSessionId);
	this.notifyMessage(0, myMessageOne);
	this.notifyMessage(0, myMessageTwo);

	object.set("type", tunnelType.TUNNEL_LOCAL);
	this.notifyMessage(0, object);
	object.set("ext_session_id", ownSessionId);
	object.set("own_session_id", extSessionId);
	this.notifyMessage(0, object);

	
}