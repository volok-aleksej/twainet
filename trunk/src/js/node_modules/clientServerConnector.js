var utils = require('twainetUtils');
var protobuf = require('protobufjs');
var ipcConn = require('ipcConnector');
var conn = require('twainetConnector');
var module = require('clientServerModule');

exports.ClientServerConnector = function(c, id, moduleName) {
	var protoFilePath = "../messages/client_server.proto",
		self = this,
		protoMap = {},
		msgMap = {};

	ipcConn.IPCConnector.call(this, c, id, moduleName);

	this.userName = "";
	this.password = "";
	this.sessionId = utils.generateId();

	//handlers of message that connector received from socket
	var handlers = function () {}
	handlers.prototype.Login = function(object) {
		console.info(object.get("name"));

		var resultCode = self.builder.build("client_server.ResultCode"),
			loginResult = self.builder.build("client_server.LoginResult"),
			myMessage = new loginResult(resultCode.LOGIN_SUCCESS, self.sessionId);
			self.sendMessage(myMessage);
	}
	handlers.prototype.LoginResult = function(object) {
		var resultCode = self.builder.build("client_server.ResultCode"),
			result = object.get("login_result"),
			newid = object.get("own_session_id");
			
		if(result == resultCode.LOGIN_SUCCESS){
			self.module.changeConnectorId(self.sessionId, newId);
			self.sessionId = newid;
		} else {
			self.destroy();
		}
	}
	handlers.prototype.InitTunnel = function(object) {
		console.info("InitTunnel", self.id);
		if(self.id == module.client) {
			console.info("init new tunnel from " + object.get("own_session_id") + " to " + object.get("ext_session_id"));
			self.module.InitTunnelServer(object, self.builder);
		}
	}
	handlers.prototype.TryConnectTo = function(object) {
		if(self.id == module.client) {
			var extSessionId = object.get("ext_session_id"),
				ownSessionId = object.get("own_session_id");
			object.set("ext_session_id", ownSessionId);
			object.set("own_session_id", extSessionId);
			self.module.notifyMessage(self, object);
		}
	}

	//handlers of message that connector get from another connector
	var notifyHandlers = function(){}
	notifyHandlers.prototype.InitTunnelStarted = function(object) {
		var ownSessionId = object.get("own_session_id");
		if(ownSessionId == self.sessionId) {
			self.sendMessage(object);
		}
	}
	notifyHandlers.prototype.InitTunnel = function(object) {
		var ownSessionId = object.get("own_session_id");
		if(ownSessionId == self.sessionId) {
			self.sendMessage(object);
		}
	}
	notifyHandlers.prototype.TryConnectTo = function(object) {
		var ownSessionId = object.get("own_session_id");
		if(ownSessionId == self.sessionId) {
			self.sendMessage(object);
		}
	}

	protobuf.loadProtoFile(protoFilePath, this.builder);
	protoMap = this.builder.build();

	msgMap = this.generateMap(protoMap, handlers.prototype);
	for(message in msgMap) if(msgMap.hasOwnProperty(message)){
		this.messageMap[message] = msgMap[message];
	}

	msgMap = this.generateMap(protoMap, notifyHandlers.prototype);
	for(message in msgMap) if(msgMap.hasOwnProperty(message)){
		this.notifyMessageMap[message] = msgMap[message];
	}
};

utils.extend(exports.ClientServerConnector, ipcConn.IPCConnector);

exports.ClientServerConnector.prototype.changeModuleName = function(moduleName) {
}

exports.ClientServerConnector.prototype.start = function() {
	conn.Connector.prototype.start.call(this);

	if(this.id == this.module.server) {
		var loginPrototype = this.builder.build("client_server.Login");
			login = new loginPrototype(this.userName, this.password);
		this.sendMessage(login);
	}
}