var utils = require('twainetUtils');
var protobuf = require('protobufjs');
var conn = require('twainetConnector');

exports.IPCConnector = function(c, id) {
	var protoFilePath = "../messages/ipc.proto",
		self = this,
		protoMap = {},
		msgMap = {};

	conn.Connector.call(this, c, id);

	this.builder = protobuf.loadProtoFile(protoFilePath);
	protoMap = this.builder.build();
	this.isExist = false;
	this.rndval = utils.rand(0, 100).toString();
	this.isCoordinator = false;

	//helper functions
	var moduleNameToId = function(ipcName) {
		return ipcName.get("module_name") + "->" + ipcName.get("host_name") + "->" + ipcName.get("suffix");
	}

	var moduleNameFromId = function(id) {
		var ipcNamePrototype = this.builder.build("ipc.IPCName"),
			ipcName = new ipcNamePrototype();
		var lastIndex = 0;
		var name = ["module_name", "host_name", "suffix"];
		var i = 0;
		for(; i < 2; i++) {
			var index = id.indexOf("->", lastIndex);
			if(index == -1){
				ipcName.set(name[i], id.substring(lastIndex));
				return ipcName;
			}

			ipcName.set(name[i], id.substring(lastIndex, index));
			lastIndex = index + 2;
		}
		ipcName.set(name[i], id.substring(lastIndex));
		return ipcName;
	}

	//handlers of message that connector received from socket
	var handlers = function () {}
	handlers.prototype.ModuleName = function(object) {
		var ipcName = object.get("ipc_name");
		self.id = moduleNameToId(ipcName);
		self.isExist = !(self.module.addModuleName(self.id), {ip:object.get("ip"), port: object.get("port")});
		var moduleState = self.builder.build("ipc.ModuleState");
		var myMessage = new moduleState(self.isExist, self.rndval);
		self.sendMessage(myMessage);

		var ipcObjectList = self.builder.build("ipc.ipcObjectList"),
			moduleList = self.module.moduleMap;
		myMessage = new ipcObjectList();
		for(moduleName in moduleList) if(moduleList.hasOwnProperty(moduleName)) {
			var module = moduleList[moduleName],
				addIPCObject = self.builder.build("ipc.AddIPCObject"),
				ipcModuleName = moduleNameFromId(moduleName),
				ipcObject = new addIPCObject(ipcModuleName, module.ip, module.port);
			myMessage.add("ipc_object", ipcObject);
		}
		self.sendMessage(myMessage);

		self.notifyMessage(self, object);
	}
	handlers.prototype.ModuleState = function(object) {
		var exist = object.get("exist"),
			randomValue = object.get("rndVal");
		if(self.isExist && exist) {
			self.destroy();
		} else if(!self.isExist && exist){
			var moduleStatePrototype = self.builder("ipc.ModuleState"),
				moduleState = new moduleStatePrototype(false, randomValue, self.id);

			self.notifyMessage(self, moduleState);
			exist = object.get("exist");
			randomValue = object.get("rndval");

			if ((exist && self.rndval > randomValue) || !exist) {
				self.destroy();
			} else if(exist && self.rndval == randomValue) {
				console.info("random values is equal");
			}
		}
	}
	handlers.prototype.AddIPCObject = function(object) {
		var ipcName = object.get("ipc_name"),
			ip = object.get("ip"),
			port = object.get("port");
		self.module.addIPCObject(moduleNameToId(ipcName), {ip: ip, port: port});
	}
	handlers.prototype.IPCObjectList = function(object) {
		var ipcObjects = object.get("ipc_object");
		for(var i = 0; i < ipcObjects.length; i++) {
			this.AddIPCObject(ipcObjects[i]);
		}
	}
	handlers.prototype.RemoveIPCObject = function(object) {
		var ipcName = object.get("ipc_name");
		self.module.removeIPCObject(ipcName);
	}
	handlers.prototype.ChangeIPCName = function(object) {
		var ipcName = object.get("ipc_name");
		self.module.changeConnectorId(self.id, moduleNameToId(ipcName));
		if(self.isCoordinator) {
			self.module.notifyMessage(object);
		}
	}
	handlers.prototype.UpdateIPCObject = function(object) {
		var ipcName = object.get("ipc_name");
		self.module.changeConnectorId(self.id, moduleNameToId(ipcName));
	}
	handlers.prototype.IPCMessage = function(object) {
		var ipcPath = object.get("ipc_path"),
			messageName = object.get("message_name"),
			message = object.get("message");
		if(ipcPath.length == 0) return;

		var ipcMessagePrototype = self.builder.build("ipc.IPCMessage"),
			ipcMessage = new ipcMessagePrototype(messageName);
		if(moduleNameToId(ipcPath[0]) == self.moduleName) {
			for(var i = 1; i < ipcPath.length; i++)
			{
				ipcMessage.add("ipc_path", ipcPath[i]);
			}

			if(ipcPath.length > 1) {
				self.onData(messageName, message);
			} else {
				ipcMessage.set("message", message);
				self.notifyMessage(ipcMessage);
			}
		}
	}

	//handlers of message that connector get from another connector
	var notifyHandlers = function(){}
	notifyHandlers.prototype.ModuleState = function(object) {
		var id = object.get("id"),
			randomValue = object.get("rndVal");
		if(id == self.m_id) {
			object.set("exist", true);
			if(self.rndval < randomValue) {
				object.set("rndval", self.rndval);
			}
		}
	}
	notifyHandlers.prototype.ChangeIPCName = function(object) {
	}
	notifyHandlers.prototype.IPCMessage = function(object) {
		var ipcPath = object.get("ipc_path");
		if(ipcPath.length == 0) return;

		if(moduleNameToId(ipcPath[0]) == self.id) {
			self.sendMessage(object);
		}
	}

	msgMap = this.generateMap(protoMap, handlers.prototype);
	for(message in msgMap) if(msgMap.hasOwnProperty(message)){
		this.messageMap[message] = msgMap[message];
	}

	msgMap = this.generateMap(protoMap, notifyHandlers.prototype);
	for(message in msgMap) if(msgMap.hasOwnProperty(message)){
		this.notifyMessageMap[message] = msgMap[message];
	}
}

utils.extend(exports.IPCConnector, conn.Connector);
