var utils = require('twainetUtils');
var module = require('twainetModule');
var conn = require('ipcConnector');
var net = require('net');

exports.IPCModule = function(name) {
	module.Module.call(this, name);

	this.moduleMap = {};
	this.ipcObjectMap = {};

	this.ip = "127.0.0.1";
	this.port = 0;
}

exports.ipcCoordinatorName = "IPCCoordinator";

utils.extend(exports.IPCModule, module.Module);

exports.IPCModule.prototype.StartAsCoordinator = function() {
	var self = this;
	this.port = 2040;
	var server = net.createServer(function(c) {
		self.addConnector(conn.IPCConnector, c, utils.generateId(), exports.ipcCoordinatorName);
	});

	server.listen(this.port, function() { //'listening' listener
		console.log('server bound');
	});
}

exports.IPCModule.prototype.addModuleName = function(name, options) {
	if(this.moduleMap[name] === undefined) {
		this.moduleMap[name] = options;
		return true;
	}
	console.log("ModuleName exist");
	return false;
}

exports.IPCModule.prototype.addIPCObject = function(name, options) {
	this.ipcObjectMap[name] = options;
}

exports.IPCModule.prototype.removeIPCObject = function(name) {
	if(this.moduleMap[name] !== undefined) {
		delete this.moduleMap[name];
	}
}

exports.IPCModule.prototype.changeConnectorId = function(oldId, newId) {
	module.Module.prototype.changeConnectorId.call(this, oldId, newId);
	if(this.moduleMap[oldId] !== undefined) {
		var moduleName = this.moduleMap[oldId];
		delete this.moduleMap[oldId];
		this.moduleMap[oldId] = moduleName;
	}
}

exports.IPCModule.prototype.onDestroy = function(conn) {
	module.Module.prototype.onDestroy.call(this, conn);
	if(this.moduleMap[conn.id] !== undefined && this.connMap[conn.id] === undefined) {
		delete this.moduleMap[conn.id];
	}
}
