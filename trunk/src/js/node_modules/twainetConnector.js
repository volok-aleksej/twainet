var protobuf = require('protobufjs');

exports.Connector = function(c, id) {
	this.socketIO = c;
	this.id = id;
	this.messageMap = {};
	this.notifyMessageMap = {};
	console.log('server connected');
};

exports.Connector.prototype.getId = function() {
	return this.id;
}

exports.Connector.prototype.start = function() {
	var self = this;

	this.socketIO.on('end', function() {
		console.log('server disconnected');
	});

	this.socketIO.on('readable', function() {
		try {
			var buffer = this.read(4)
			var lenPacket = buffer.readInt32LE(0);
			if(lenPacket < 0 || lenPacket > 0x7fff) {
				self.destroy();
			}

			buffer = this.read(4);
			var lenMessageName = buffer.readInt32LE(0);
			if(lenPacket < lenMessageName + 4) {
				self.destroy();
			}

			buffer = this.read(lenMessageName);
			var messageName = buffer.toString();
			buffer = this.read(lenPacket - lenMessageName - 4);
			onData(messageName, buffer);
		} catch(e) {
			console.log(e);
			self.destroy();
		}
	});

	var onData = function(msgName, buffer) {
			message = self.builder.build(msgName),
			messageObject = message.decode(buffer);

		for(var mesName in self.messageMap) if(self.messageMap.hasOwnProperty(mesName)) {
			if(mesName == msgName) {
				self.messageMap[mesName](messageObject);
			}
		}
	};
}

exports.Connector.prototype.destroy = function() {
	this.socketIO.destroy();
	this.module.onDestroy(this.id);
}

exports.Connector.prototype.sendMessage = function(messageObject) {
	var data = messageObject.encode(),
		messageName = this.getMessageName(messageObject),
		length = messageName.length + 4 + data.length,
		buffer = new Buffer(length + 4);

	buffer.writeInt32LE(length, 0);
	buffer.writeInt32LE(messageName.length, 4);
	buffer.write(messageName, 8);
	data.toBuffer().copy(buffer, messageName.length + 8);
	this.socketIO.write(buffer);
}

exports.Connector.prototype.getMessageName = function(messageObject) {
	var messageName = messageObject.toString();
	messageName = messageName.substring(1);
	return messageName;
}

exports.Connector.prototype.generateMap = function(protoMap, funcMap) {
	var map = {};
	for(var msgName in protoMap) if(protoMap.hasOwnProperty(msgName)) {
		if(funcMap.hasOwnProperty(msgName)) {
			map[msgName] = funcMap[msgName];
			continue;
		}

		var childMap = this.generateMap(protoMap[msgName], funcMap);
		for(var childName in childMap) if(childMap.hasOwnProperty(childName)) {
			map[msgName + "." + childName] = childMap[childName];
		}
	}
	return map;
}

exports.Connector.prototype.onMessage = function(messageObject) {
	var msgName = this.getMessageName(messageObject);
	for(var mesName in this.notifyMessageMap) if(this.notifyMessageMap.hasOwnProperty(mesName)) {
		if(mesName == msgName) {
			this.notifyMessageMap[mesName](messageObject);
		}
	}
}